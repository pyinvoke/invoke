version: 2.1


orbs:
  orb: invocations/orb@1.3.1

executors:
  # Basically extending what the python orb's executor does:
  # - s/tag/version/
  # - default to 3.6, not 3.8 or w/e
  # - set common environment vars
  default:
    parameters:
      version:
        type: string
        default: "3.11"
    docker:
      - image: cimg/python:<< parameters.version >>
      # TODO: explicitly select 'resource_class: small' if credits ever become
      # too tight; seems like small uses 5 credits/min and medium, the default,
      # uses 10
    environment:
      TERM: screen-256color

jobs:
  # Unit+integration tests, with coverage
  coverage:
    executor:
      name: default
    steps:
      - orb/setup
      - run: inv ci.make-sudouser
      - orb/sudo-coverage
      - orb/debug

  regression:
    executor:
      name: default
    steps:
      - orb/setup
      - run: inv regression
      - orb/debug

  doctests:
    executor:
      name: default
    steps:
      - orb/setup
      - run: inv www.doctest
      - orb/debug

  typecheck:
    executor:
      name: default
    steps:
      - orb/setup
      - run: mypy .
      - orb/debug


workflows:
  main:
    jobs:
      - orb/lint:
          name: Lint
      - orb/format:
          name: Style check
      - typecheck:
          name: Types check
      - coverage:
          name: Test
      - regression:
          name: Regression tests
      - orb/test-release:
          name: Release test
      - orb/test:
          name: Test << matrix.version >>
          requires: ["Test"]
          matrix:
            parameters:
              version: ["3.9", "3.10", "3.11"]
      - orb/docs:
          name: "Docs"
          requires: ["Test"]
      - doctests:
          name: "Doctests"
          requires: ["Docs"]
